name: Deploy

# Run deploy only on tag and master builds.
on:
  push:
    branches:
      - master
  release:
    types: [prereleased]

jobs:

  deploy:
    name: Create release asset
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'

      - name: Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '5.6'
          tools: composer:v2

      - name: Install NPM dependencies
        run: npm install

      - name: Clean dist directory
        run: rm -rf dist

      - name: Copy necessary files
        run: |
          mkdir -p dist/includes
          rsync -a --exclude-from='.distignore' ./ dist/
          cp node_modules/qrcode-generator/qrcode.js dist/includes

      - name: Prepare for artifact creation
        run: |
             rm -rf node_modules
             mkdir two-factor
             rsync -a ./ ./two-factor --exclude two-factor
             mkdir build

      - name: Create artifact
        uses: montudor/action-zip@v1
        with:
          args: zip -X -r build/two-factor-${{ github.event.release.tag_name }}.zip two-factor -x *.git* *node_modules/\* .* "*/\.*" *CODE_OF_CONDUCT.md *readme-dev.md *.phar *appsero.json *CONTRIBUTING.md *ISSUE_TEMPLATE.md *PULL_REQUEST_TEMPLATE.md *.dist *.neon *composer* *package* *phpunit* *webpack* *tests**

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: two-factor
          path: build/two-factor-${{ github.event.release.tag_name }}.zip

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: build/two-factor-${{ github.event.release.tag_name }}.zip
        env:
          GITHUB_TOKEN: ${{ github.token }}
